# Simulation Module

This module provides comprehensive simulation capabilities for generating test data in the PeerBench platform. It supports both simple persona-based simulations and realistic LLM-generated user simulations.

## Features

### 1. Simple Simulation (In-Memory)
- **Personas**: Altruistic, Greedy, Cabal, Random, Malicious
- **Use Case**: Testing scoring algorithms and leaderboard logic
- **Data Generated**: Users, prompts, and feedback
- **Cost**: Free (no LLM calls)

### 2. Realistic Simulation (LLM-Powered)
- **AI-Generated**: Uses Gemini 2.0 Flash via OpenRouter
- **Personalities**: Unique researcher/developer personas
- **Benchmarks**: Custom benchmark themes based on user interests
- **Prompts**: High-quality test prompts generated by LLM
- **Database Integration**: Can write users to database with proper auth/profile/org setup
- **Cost**: Uses OpenRouter API (paid, but very low cost)

## Architecture

```
/sim
├── types.ts                 # Type definitions
├── index.ts                 # Public API exports
├── core/
│   └── simulation.ts        # Core simulation logic
├── db/
│   └── user-creation.ts     # Database operations (Drizzle + Supabase Auth)
├── llm/
│   ├── generators.ts        # LLM generators for personalities/prompts
│   └── realistic-simulation.ts  # Realistic simulation orchestration
└── components/              # (future) React components
```

## Usage

### Simple Simulation

```typescript
import { runSimulation, DEFAULT_SIMPLE_SIMULATION_CONFIG } from '@/sim';

const config = {
  ...DEFAULT_SIMPLE_SIMULATION_CONFIG,
  numUsers: 100,
  in_memory_only: true,
  write_to_db: false,
  realistic_people: false,
};

const result = await runSimulation(config);
console.log(`Generated ${result.users.length} users`);
console.log(`Generated ${result.prompts.length} prompts`);
console.log(`Generated ${result.feedbacks.length} feedbacks`);
```

### Realistic Simulation

```typescript
import { runSimulation, DEFAULT_REALISTIC_SIMULATION_CONFIG } from '@/sim';

const config = {
  ...DEFAULT_REALISTIC_SIMULATION_CONFIG,
  numUsers: 10,
  realistic_people: true,
  in_memory_only: false,
  write_to_db: true,
  llmModel: 'google/gemini-2.0-flash-001',
};

const result = await runSimulation(config);
// Users are created in the database with:
// - auth.users entry (via Supabase Auth Admin API)
// - user_profile entry with simulated metadata
// - org_to_people link to random organization
```

## Configuration Parameters

### Common Parameters
- `realistic_people`: `boolean` - Use LLM-generated personas vs simple personas
- `in_memory_only`: `boolean` - Only generate data in memory (don't persist)
- `write_to_db`: `boolean` - Write data to database (requires `in_memory_only: false`)

### Simple Simulation Config
- `numUsers`: Number of users to generate
- `personas`: Percentage distribution (altruistic, greedy, cabal, random, malicious)
- `numPromptsPerUser`: Min/max prompts per user
- `probabilityReview`: Probability a user reviews a prompt
- `probabilityMultipleReviews`: Probability a prompt gets 3+ reviews
- `percentageGoodPrompts`: Percentage of prompts that are "good quality"
- `cabalSize`: Users per cabal group

### Realistic Simulation Config
- `numUsers`: Number of users to generate (keep low for cost)
- `llmModel`: OpenRouter model ID (default: `google/gemini-2.0-flash-001`)
- `promptsPerUser`: Min/max prompts per user
- `orgDomains`: Optional array to limit to specific organization domains

## Database Schema

### User Creation Flow
1. **auth.users** - Created via Supabase Auth Admin API
   - `email`: Generated from personality name + org domain
   - `email_confirm`: Auto-confirmed
   - `user_metadata`: Contains simulation metadata

2. **user_profile** - Created via Drizzle
   - `user_id`: Links to auth.users
   - `display_name`: Generated by LLM or persona name
   - `metadata`: Marks as simulated user with personality/benchmark data

3. **org_to_people** - Created via Drizzle
   - Links user to random organization with domains

### Simulation Metadata

```typescript
{
  isSimulated: true,
  simulationType: 'realistic' | 'simple',
  personality: {
    name: string,
    background: string,
    interests: string[],
    behaviorTraits: string[],
    reviewStyle: string,
    promptCreationStyle: string
  },
  benchmarkIdea: {
    theme: string,
    description: string,
    targetDomain: string,
    promptCount: number
  }
}
```

## Admin Interface

Access the simulation panel at `/adminSimulate`:

1. **Simple Mode**: Configure persona distribution and parameters
2. **Realistic Mode**: Set LLM model and user count
3. **Options**: Toggle in-memory vs database persistence
4. **Results**: View generated users, prompts, and feedback counts

## Environment Variables

Required for realistic simulations with database writes:

```bash
# OpenRouter API (for LLM generation)
OPENROUTER_API_KEY=your-key-here

# Supabase (for auth user creation)
NEXT_PUBLIC_SUPABASE_URL=your-supabase-url
SUPABASE_SERVICE_ROLE_KEY=your-service-role-key
# OR
SUPABASE_SECRET_KEY=your-secret-key

# Database (for Drizzle operations)
DATABASE_URL=your-postgres-connection-string
```

## Persona Behaviors

### Simple Personas

1. **Altruistic**: Honest reviews based on actual prompt quality
2. **Greedy**: Only reviews own prompts positively, ignores others
3. **Cabal**: Upvotes cabal members, downvotes outsiders
4. **Random**: Completely random opinions
5. **Malicious**: Intentionally wrong reviews (good → negative, bad → positive)

### Realistic Personas

Generated by LLM with:
- Unique name and background
- Research interests
- Behavioral traits
- Review style
- Prompt creation approach
- Custom benchmark theme

## Future Enhancements

- [ ] Add prompt set creation for realistic users
- [ ] Generate actual model responses using LLM
- [ ] Add scoring/evaluation for realistic prompts
- [ ] Support batch operations for large-scale simulations
- [ ] Add simulation templates for common scenarios
- [ ] Enhance feedback generation with LLM-based reviews

## Migration from Old Simulation

The old simulation code in `/lib/leaderboard/simulation.ts` now imports from this module:

```typescript
// Old
import { runSimulation } from '@/lib/leaderboard/simulation';

// New (automatically redirected)
import { runSimulation } from '@/sim';
```

Both will work, but prefer importing directly from `@/sim` for new code.
